name: Generate HTML Report and Send Email

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run PowerShell script to generate HTML report
        run: pwsh ./generate-report.ps1

      - name: Upload HTML report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-report
          path: report.html

  send_mail:
    needs: build  # ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: daily-report

      - name: Show downloaded files (Debug)
        run: ls -la

      - name: Send email using SendGrid API with cURL
        run: |
          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{
              "personalizations": [
                {
                  "to": [
                    {
                      "email": "ashjan.aljbreen@gmail.com"
                    }
                  ],
                  "subject": "âœ… Daily HTML Report Ready!"
                }
              ],
              "from": {
                "email": "ashjannnnnnn@gmail.com"
              },
              "content": [
                {
                  "type": "text/plain",
                  "value": "Hi Team! ðŸ‘‹\n\nThe daily HTML report is ready.\n\nðŸš€ Regards,\nDevOps Bot"
                }
              ]
            }'
