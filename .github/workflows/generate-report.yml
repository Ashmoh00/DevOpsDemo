name: Generate PDF Report and Send Email

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate PDF Report (PowerShell)
        run: |
          # ØªØ­ØªØ§Ø¬ÙŠÙ† ØªÙˆÙ„ÙŠØ¯ PDF Ø¨Ø·Ø±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ
          # Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Out-File Ù„Ù†Øµ Ø¹Ø§Ø¯ÙŠ Ø¨ØµÙŠØºØ© PDF (Ù…Ø«Ø§Ù„ ØªÙˆØ¶ÙŠØ­ÙŠ)
          echo "This is your PDF report content!" | Out-File -FilePath report.pdf -Encoding utf8

      - name: Upload PDF report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-report
          path: report.pdf

      - name: Encode PDF report to Base64
        id: encode
        run: |
          base64 report.pdf | tr -d '\n' > encoded.txt
          echo "ENCODED=$(cat encoded.txt)" >> $GITHUB_ENV

  send_mail:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download PDF Artifact
        uses: actions/download-artifact@v4
        with:
          name: daily-report

      - name: Show downloaded files (Debug)
        run: ls -la

      - name: Encode PDF again (if needed)
        run: |
          base64 report.pdf | tr -d '\n' > encoded.txt
          echo "ENCODED=$(cat encoded.txt)" >> $GITHUB_ENV

      - name: Send email with SendGrid API (cURL)
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header "Content-Type: application/json" \
            --data "{
              \"personalizations\": [{
                \"to\": [{ \"email\": \"ashjan.aljbreen@gmail.com\" }],
                \"subject\": \"âœ… Daily PDF Report Ready!\"
              }],
              \"from\": { \"email\": \"ashjannnnnnn@gmail.com\" },
              \"content\": [{
                \"type\": \"text/plain\",
                \"value\": \"Hi Team! ðŸ‘‹ Please find the attached PDF report.\"
              }],
              \"attachments\": [{
                \"content\": \"${ENCODED}\",
                \"type\": \"application/pdf\",
                \"filename\": \"report.pdf\"
              }]
            }"
